<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- ==================== TREE VIEW (C·∫£i ti·∫øn) ==================== -->
        <record id="view_meeting_room_booking_tree" model="ir.ui.view">
            <field name="name">meeting.room.booking.tree</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <tree decoration-danger="has_conflict==True" 
                      decoration-warning="state=='pending'"
                      decoration-info="state=='confirmed'"
                      decoration-success="state=='completed'"
                      decoration-muted="state=='cancelled'">
                    <field name="name"/>
                    <field name="room_id"/>
                    <field name="subject"/>
                    <field name="organizer_id"/>
                    <field name="start_time"/>
                    <field name="end_time"/>
                    <field name="duration" widget="float_time"/>
                    <field name="expected_attendees"/>
                    
                    <!-- C·∫£nh b√°o xung ƒë·ªôt -->
                    <field name="has_conflict" invisible="1"/>
                    <field name="conflict_count" string="‚ö†Ô∏è" optional="show"/>
                    
                    <!-- Ph√™ duy·ªát -->
                    <field name="require_approval" invisible="1"/>
                    <field name="approval_level" optional="hide"/>
                    <field name="approved_by_id" optional="hide"/>
                    
                    <!-- Thi·∫øt b·ªã -->
                    <field name="equipment_prepared" widget="boolean_toggle" optional="hide"/>
                    
                    <!-- Tr·∫°ng th√°i -->
                    <field name="state" widget="badge" 
                           decoration-success="state=='confirmed'" 
                           decoration-info="state=='in_progress'"
                           decoration-warning="state=='pending'"
                           decoration-muted="state in ['completed','cancelled']"/>
                </tree>
            </field>
        </record>

        <!-- ==================== FORM VIEW (ƒê·∫ßy ƒë·ªß) ==================== -->
        <record id="view_meeting_room_booking_form" model="ir.ui.view">
            <field name="name">meeting.room.booking.form</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <!-- Draft -> Pending -->
                        <button name="action_submit_for_approval" string="G·ª≠i ph√™ duy·ªát" 
                                type="object" class="oe_highlight" 
                                attrs="{'invisible': ['|', ('state', '!=', 'draft'), ('require_approval', '=', False)]}"/>
                        
                        <!-- Pending -> Confirmed (Approve) -->
                        <button name="action_approve" string="‚úì Ph√™ duy·ªát" 
                                type="object" class="oe_highlight" 
                                attrs="{'invisible': [('state', '!=', 'pending')]}"
                                groups="hr.group_hr_manager"/>
                        
                        <!-- Pending -> Cancelled (Reject) -->
                        <button name="action_reject" string="‚úó T·ª´ ch·ªëi" 
                                type="object" 
                                attrs="{'invisible': [('state', '!=', 'pending')]}"
                                groups="hr.group_hr_manager"/>
                        
                        <!-- Draft -> Confirmed (Kh√¥ng c·∫ßn ph√™ duy·ªát) -->
                        <button name="action_approve" string="X√°c nh·∫≠n" 
                                type="object" class="oe_highlight" 
                                attrs="{'invisible': ['|', ('state', '!=', 'draft'), ('require_approval', '=', True)]}"/>
                        
                        <!-- Confirmed -> In Progress (Check-in) -->
                        <button name="action_check_in" string="üìç Check-in" 
                                type="object" class="oe_highlight" 
                                attrs="{'invisible': [('state', '!=', 'confirmed')]}"/>
                        
                        <!-- In Progress -> Completed (Check-out) -->
                        <button name="action_check_out" string="‚úì Check-out" 
                                type="object" class="oe_highlight" 
                                attrs="{'invisible': [('state', '!=', 'in_progress')]}"/>
                        
                        <!-- Suggest Alternative -->
                        <button name="action_suggest_alternatives" string="üîç G·ª£i √Ω ph√≤ng kh√°c" 
                                type="object" 
                                attrs="{'invisible': [('has_conflict', '=', False)]}"/>
                        
                        <!-- Cancel -->
                        <button name="action_cancel" string="H·ªßy" 
                                type="object" 
                                attrs="{'invisible': [('state', 'in', ['completed', 'cancelled'])]}"/>
                        
                        <field name="state" widget="statusbar" 
                               statusbar_visible="draft,pending,confirmed,in_progress,completed"/>
                    </header>
                    
                    <sheet>
                        <!-- Hidden fields for attrs -->
                        <field name="has_conflict" invisible="1"/>
                        <field name="conflict_count" invisible="1"/>
                        <field name="require_approval" invisible="1"/>
                        <field name="approval_level" invisible="1"/>
                        
                        <!-- C·∫£nh b√°o xung ƒë·ªôt -->
                        <div class="alert alert-danger" role="alert" 
                             attrs="{'invisible': [('has_conflict', '=', False)]}">
                            <strong>‚ö†Ô∏è C·∫£nh b√°o xung ƒë·ªôt!</strong><br/>
                            C√≥ <field name="conflict_count" class="oe_inline"/> booking kh√°c xung ƒë·ªôt th·ªùi gian v·ªõi ph√≤ng n√†y.
                            <button name="action_suggest_alternatives" string="Xem ph√≤ng g·ª£i √Ω" type="object" class="btn-link"/>
                        </div>
                        
                        <!-- Y√™u c·∫ßu ph√™ duy·ªát -->
                        <div class="alert alert-warning" role="alert" 
                             attrs="{'invisible': [('require_approval', '=', False)]}">
                            <strong>‚ÑπÔ∏è Y√™u c·∫ßu ph√™ duy·ªát</strong><br/>
                            Booking n√†y c·∫ßn ph√™ duy·ªát c·∫•p <field name="approval_level" class="oe_inline"/>.
                        </div>
                        
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" readonly="1"/></h1>
                            <label for="subject" class="oe_edit_only"/>
                            <h2><field name="subject" placeholder="Ch·ªß ƒë·ªÅ cu·ªôc h·ªçp..."/></h2>
                        </div>
                        
                        <group>
                            <group string="Th√¥ng tin ph√≤ng h·ªçp">
                                <field name="room_id" options="{'no_create': True}"/>
                                <field name="room_location_id" readonly="1"/>
                                <field name="booker_id"/>
                                <field name="organizer_id"/>
                            </group>
                            <group string="Th·ªùi gian">
                                <field name="start_time"/>
                                <field name="end_time"/>
                                <field name="duration" widget="float_time"/>
                                <field name="expected_attendees"/>
                            </group>
                        </group>
                        
                        <group>
                            <field name="description" placeholder="M√¥ t·∫£ chi ti·∫øt cu·ªôc h·ªçp..."/>
                        </group>
                        
                        <notebook>
                            <!-- Tab 1: Ng∆∞·ªùi tham d·ª± -->
                            <page string="Ng∆∞·ªùi tham d·ª±" name="attendees">
                                <field name="attendee_ids" widget="many2many_tags">
                                    <tree>
                                        <field name="name"/>
                                        <field name="department_id"/>
                                        <field name="work_email"/>
                                        <field name="phone"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <!-- Tab 2: Thi·∫øt b·ªã -->
                            <page string="Thi·∫øt b·ªã" name="equipment">
                                <group>
                                    <group>
                                        <field name="equipment_prepared" widget="boolean_toggle"/>
                                        <field name="equipment_checked_by" readonly="1" 
                                               attrs="{'invisible': [('equipment_prepared', '=', False)]}"/>
                                        <field name="equipment_checked_date" readonly="1" 
                                               attrs="{'invisible': [('equipment_prepared', '=', False)]}"/>
                                    </group>
                                    <group>
                                        <button name="action_prepare_equipment" string="‚úì ƒê√°nh d·∫•u ƒë√£ chu·∫©n b·ªã" 
                                                type="object" class="oe_highlight"
                                                attrs="{'invisible': ['|', ('equipment_prepared', '=', True), ('equipment_ids', '=', [])]}"/>
                                        <button name="action_return_equipment" string="‚Ü© Tr·∫£ l·∫°i thi·∫øt b·ªã" 
                                                type="object"
                                                attrs="{'invisible': [('equipment_prepared', '=', False)]}"/>
                                        <button name="action_report_equipment_issue" string="‚ö† B√°o c√°o s·ª± c·ªë" 
                                                type="object" class="btn-warning"
                                                attrs="{'invisible': [('equipment_ids', '=', [])]}"/>
                                    </group>
                                </group>
                                
                                <field name="equipment_ids" 
                                       context="{'default_location_id': room_location_id}"
                                       domain="[('location_id', '=', room_location_id), ('state', '=', 'available')]">
                                    <tree>
                                        <field name="name"/>
                                        <field name="category_id"/>
                                        <field name="state" widget="badge"/>
                                        <field name="location_id"/>
                                    </tree>
                                </field>
                                
                                <group>
                                    <field name="equipment_notes" placeholder="Ghi ch√∫ v·ªÅ thi·∫øt b·ªã (y√™u c·∫ßu ƒë·∫∑c bi·ªát, setup, v.v.)"/>
                                </group>
                            </page>
                            
                            <!-- Tab 3: Ph√™ duy·ªát -->
                            <page string="Ph√™ duy·ªát" name="approval" 
                                  attrs="{'invisible': [('require_approval', '=', False)]}">
                                <group>
                                    <group>
                                        <field name="require_approval" readonly="1"/>
                                        <field name="approval_level" readonly="1"/>
                                        <field name="approved_by_id" readonly="1"/>
                                        <field name="approved_date" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="rejection_reason" readonly="1" 
                                               attrs="{'invisible': [('state', '!=', 'cancelled')]}"/>
                                    </group>
                                </group>
                            </page>
                            
                            <!-- Tab 4: Check-in / Check-out -->
                            <page string="Check-in/out" name="checkin">
                                <group>
                                    <group>
                                        <field name="check_in_time" readonly="1"/>
                                        <field name="check_out_time" readonly="1"/>
                                        <field name="auto_cancel_if_no_checkin"/>
                                    </group>
                                </group>
                            </page>
                            
                            <!-- Tab 5: ƒê√°nh gi√° & Th·ªëng k√™ -->
                            <page string="ƒê√°nh gi√°" name="feedback" 
                                  attrs="{'invisible': [('state', '!=', 'completed')]}">
                                <group>
                                    <group>
                                        <field name="actual_attendees"/>
                                        <field name="rating" widget="priority"/>
                                    </group>
                                </group>
                                <group>
                                    <field name="feedback" placeholder="Ph·∫£n h·ªìi v·ªÅ cu·ªôc h·ªçp, ph√≤ng, thi·∫øt b·ªã..."/>
                                </group>
                                
                                <!-- <button name="action_feedback" string="üìù C·∫≠p nh·∫≠t ƒë√°nh gi√°" 
                                        type="object" class="oe_highlight"/> -->
                            </page>
                        </notebook>
                    </sheet>
                    
                    <!-- Chatter -->
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- ==================== KANBAN VIEW ==================== -->
        <record id="view_meeting_room_booking_kanban" model="ir.ui.view">
            <field name="name">meeting.room.booking.kanban</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="state">
                    <field name="name"/>
                    <field name="subject"/>
                    <field name="room_id"/>
                    <field name="organizer_id"/>
                    <field name="start_time"/>
                    <field name="end_time"/>
                    <field name="state"/>
                    <field name="has_conflict"/>
                    <field name="color"/>
                    <field name="equipment_prepared"/>
                    
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.color.raw_value)} oe_kanban_card oe_kanban_global_click">
                                <div class="o_dropdown_kanban dropdown">
                                    <a class="dropdown-toggle o-no-caret btn" role="button" data-toggle="dropdown" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <a role="menuitem" type="edit" class="dropdown-item">S·ª≠a</a>
                                        <a role="menuitem" type="delete" class="dropdown-item">X√≥a</a>
                                    </div>
                                </div>
                                
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="subject"/>
                                            </strong>
                                        </div>
                                        <span t-if="record.has_conflict.raw_value" class="badge badge-danger">‚ö†Ô∏è Xung ƒë·ªôt</span>
                                    </div>
                                    
                                    <div class="o_kanban_record_body">
                                        <field name="name" class="text-muted"/>
                                        <div>
                                            <i class="fa fa-map-marker" title="Ph√≤ng h·ªçp"/> <field name="room_id"/>
                                        </div>
                                        <div>
                                            <i class="fa fa-user" title="Ng∆∞·ªùi t·ªï ch·ª©c"/> <field name="organizer_id"/>
                                        </div>
                                        <div>
                                            <i class="fa fa-clock-o"/> 
                                            <t t-esc="record.start_time.value.toLocaleString()"/>
                                        </div>
                                        <div t-if="record.equipment_prepared.raw_value">
                                            <span class="badge badge-success">‚úì Thi·∫øt b·ªã ƒë√£ chu·∫©n b·ªã</span>
                                        </div>
                                    </div>
                                    
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <field name="activity_ids" widget="kanban_activity"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ==================== CALENDAR VIEW (C·∫£i ti·∫øn) ==================== -->
        <record id="view_meeting_room_booking_calendar" model="ir.ui.view">
            <field name="name">meeting.room.booking.calendar</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <calendar string="L·ªãch ƒë·∫∑t ph√≤ng" 
                          date_start="start_time" 
                          date_stop="end_time" 
                          color="state"
                          quick_add="False"
                          mode="month"
                          event_open_popup="true">
                    <field name="name"/>
                    <field name="subject"/>
                    <field name="room_id"/>
                    <field name="organizer_id"/>
                    <field name="state"/>
                    <field name="has_conflict"/>
                    <field name="color"/>
                </calendar>
            </field>
        </record>

        <!-- ==================== SEARCH VIEW (ƒê·∫ßy ƒë·ªß filters) ==================== -->
        <record id="view_meeting_room_booking_search" model="ir.ui.view">
            <field name="name">meeting.room.booking.search</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name"/>
                    <field name="subject"/>
                    <field name="room_id"/>
                    <field name="organizer_id"/>
                    <field name="booker_id"/>
                    
                    <!-- Filters theo tr·∫°ng th√°i -->
                    <separator/>
                    <filter string="Nh√°p" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Ch·ªù duy·ªát" name="pending" domain="[('state', '=', 'pending')]"/>
                    <filter string="ƒê√£ x√°c nh·∫≠n" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                    <filter string="ƒêang di·ªÖn ra" name="in_progress" domain="[('state', '=', 'in_progress')]"/>
                    <filter string="Ho√†n th√†nh" name="completed" domain="[('state', '=', 'completed')]"/>
                    <filter string="ƒê√£ h·ªßy" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                    
                    <!-- Filters theo th·ªùi gian -->
                    <separator/>
                    <filter string="H√¥m nay" name="today" 
                            domain="[('start_time', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))), 
                                     ('start_time', '&lt;', datetime.datetime.combine(context_today() + datetime.timedelta(days=1), datetime.time(0,0,0)))]"/>
                    <filter string="Tu·∫ßn n√†y" name="this_week" 
                            domain="[('start_time', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                     ('start_time', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <filter string="Th√°ng n√†y" name="this_month" 
                            domain="[('start_time', '&gt;=', datetime.datetime.now().strftime('%Y-%m-01'))]"/>
                    
                    <!-- Filters ƒë∆°n gi·∫£n -->
                    <separator/>
                    <filter string="‚úì C√≥ thi·∫øt b·ªã" name="has_equipment" domain="[('equipment_ids', '!=', False)]"/>
                    <filter string="‚úì Thi·∫øt b·ªã ƒë√£ chu·∫©n b·ªã" name="equipment_ready" domain="[('equipment_prepared', '=', True)]"/>
                    <filter string="üë§ Booking c·ªßa t√¥i" name="my_bookings" domain="[('booker_id.user_id', '=', uid)]"/>
                    <filter string="üë• T√¥i tham d·ª±" name="i_attend" domain="[('attendee_ids.user_id', '=', uid)]"/>
                    
                    <!-- Group By -->
                    <group expand="0" string="Group By">
                        <filter string="Ph√≤ng h·ªçp" name="group_room" context="{'group_by': 'room_id'}"/>
                        <filter string="Ng∆∞·ªùi t·ªï ch·ª©c" name="group_organizer" context="{'group_by': 'organizer_id'}"/>
                        <filter string="Tr·∫°ng th√°i" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Ng√†y b·∫Øt ƒë·∫ßu" name="group_start_date" context="{'group_by': 'start_time:day'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ==================== PIVOT VIEW (Th·ªëng k√™) ==================== -->
        <record id="view_meeting_room_booking_pivot" model="ir.ui.view">
            <field name="name">meeting.room.booking.pivot</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <pivot string="Th·ªëng k√™ ƒë·∫∑t ph√≤ng">
                    <field name="room_id" type="row"/>
                    <field name="state" type="col"/>
                    <field name="duration" type="measure"/>
                    <field name="expected_attendees" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- ==================== GRAPH VIEW (Bi·ªÉu ƒë·ªì) ==================== -->
        <record id="view_meeting_room_booking_graph" model="ir.ui.view">
            <field name="name">meeting.room.booking.graph</field>
            <field name="model">meeting.room.booking</field>
            <field name="arch" type="xml">
                <graph string="Bi·ªÉu ƒë·ªì ƒë·∫∑t ph√≤ng" type="bar">
                    <field name="room_id"/>
                    <field name="duration" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- ==================== ACTION ==================== -->
        <record id="action_meeting_room_booking" model="ir.actions.act_window">
            <field name="name">ƒê·∫∑t ph√≤ng h·ªçp</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">meeting.room.booking</field>
            <field name="view_mode">calendar,kanban,tree,form,pivot,graph</field>
            <field name="search_view_id" ref="view_meeting_room_booking_search"/>
            <field name="context">{
                'search_default_today': 1,
                'search_default_confirmed': 1,
                'search_default_in_progress': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    T·∫°o booking ph√≤ng h·ªçp m·ªõi
                </p>
                <p>
                    H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra xung ƒë·ªôt th·ªùi gian v√† g·ª£i √Ω ph√≤ng thay th·∫ø.
                </p>
            </field>
        </record>
    </data>
</odoo>
